# week06-ì½”ì±„/ìœ ì±„ì›

- ë¯¸ì…˜ 1
    
    ```jsx
    //store.repository.js
    import { prisma } from "../db.config.js";
    
    export const addStore = async (data) => {
    
      try {
        const existingStore = await prisma.store.findUnique({
          where: {businessNumber: data.business_number}
        });
    
        if (existingStore) {
          return null;
        }
    
        const region = await prisma.region.findUnique({
          where: { name: data.region_name}
        })
    
        if (!region){
          throw new Error(`ì§€ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data.region_name}`);
        }
    
        // store ìƒì„±
        const newStore = await prisma.store.create({
          data: {
            businessNumber: data.business_number,
            regionId: region.id,
            name: data.name,
            address: data.address,
          }
        });
    
        return newStore.id;
    
      } catch (err) {
        throw new Error(
          `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (${err})`
        );
      }
    };
    export const getStore = async (storeId) => {
    
      try {
        const store = await prisma.store.findUnique({
          where: { id: storeId }
        })
    
        if (!store) {
          return null;
        }
    
        return store;
    
      } catch (err) {
        throw new Error(
          `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (${err})`
        );
      } 
    };
    ```
    
    **findUnique  - ë¹ ë¥´ë‹¤**
    SQL: SELECT * FROM store WHERE id = 1;
    â†’ Primary Key ì¸ë±ìŠ¤ ì§ì ‘ ì‚¬ìš©
    
    **findFirst - ìƒëŒ€ì ìœ¼ë¡œ ëŠë¦¼**
    SQL: SELECT * FROM store WHERE id = 1 LIMIT 1;
    â†’ ì¼ë°˜ ê²€ìƒ‰ í›„ LIMIT
    
    ![image.png](image.png)
    
    ì •ìƒ ì‘ë™ í™•ì¸ ğŸ˜Š
    
    ```jsx
    //review.repository.js
    import { prisma } from "../db.config.js";
    
    export const addReview = async (data) => {
      try {
        // 1. íƒ€ì… ë³€í™˜ (store_id ì‚¬ìš©!)
        const storeId = parseInt(data.store_id);
    
        // 2. ê°€ê²Œ ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
        const existingStore = await prisma.store.findUnique({
          where: { id: storeId }
        });
    
        if (!existingStore) {
          return null;
        }
    
        // 3. review ìƒì„±
        const newReview = await prisma.review.create({
          data: {
            userId: 19,
            storeId: storeId,
            body: data.body,
            score: data.score,
          }
        });
    
        // 4. í‰ê·  ì ìˆ˜ ê³„ì‚°
        const average = await prisma.review.aggregate({
          _avg: {
            score: true
          },
          where: {
            storeId: storeId
          }
        });
    
        const newAvgScore = average._avg.score;
    
        // 5. store í…Œì´ë¸”ì— í‰ê·  í‰ì  ì—…ë°ì´íŠ¸
        await prisma.store.update({
          where: {
            id: storeId
          },
          data: {
            score: newAvgScore
          }
        });
    
        console.log("store í‰ê·  í‰ì ì´ " + newAvgScore + "ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    
        return newReview.id;
    
      } catch (err) {
        throw new Error(
          `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (${err})`
        );
      }
    };
    
    export const getReview = async (reviewId) => {
      try {
        const review = await prisma.review.findUnique({
          where: { id: reviewId }
        });
    
        if (!review) {
          return null;
        }
        
        return review;
    
      } catch (err) {
        throw new Error(
          `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (${err})`
        );
      }
    };
    
    export const getAllStoreReviews = async (storeId, cursor) => {
      const reviews = await prisma.review.findMany({
        select: { id: true, body: true, storeId: true, userId: true },
        where: { storeId: storeId, id: { gt: cursor } },
        orderBy: { id: "asc" },
        take: 5,
      });
    
      return reviews;
    };
    ```
    
    ** paramìœ¼ë¡œ ë„˜ì–´ì˜¤ëŠ” ì¸ìê°€ í•­ìƒ ë¬¸ìì—´ë¡œ ë„˜ì–´ì˜¤ëŠ” ë¬¸ì œ ë°œìƒë˜ì–´ parseIntë¡œ ì²˜ë¦¬
    
    ![image.png](image%201.png)
    
    ```jsx
    //mission.repository.js
    import { StatusCodes } from "http-status-codes";
    import { bodyToMission, bodyToChallenge } from "../dtos/mission.dto.js";
    import { missionCreate, challengeCreate } from "../services/mission.service.js";
    
    export const handleMissionCreate = async (req, res, next) => {
        const store_id = parseInt(req.params.storeId);  //ì—¬ê¸°ì„œ ë³€í™˜
        console.log("ë¯¸ì…˜ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!");
        console.log("body:", req.body);
        const entireMissionData = {
            ...req.body,
            store_id,  // pathvariable
        };
        console.log("entireMissionData:", entireMissionData);
    
        const mission = await missionCreate(bodyToMission(entireMissionData));
        res.status(StatusCodes.OK).json({ result: mission });
    }
    
    export const handleChallengeCreate = async (req, res, next) => {
        const mission_id = req.params.missionId;
        console.log("ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!");
        console.log("body:", req.body);
        const entireChallengeData = {
            ...req.body,
            mission_id,  // pathvariable
        };
    
        const challenge = await challengeCreate(bodyToChallenge(entireChallengeData));
        res.status(StatusCodes.OK).json({ result: challenge });
    }
    ```
    
    ì •ìƒ ì‘ë™ í™•ì¸ ğŸ˜Š
    
    ![image.png](image%202.png)
    
- ë¯¸ì…˜ 2 (ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·° ëª©ë¡)
    - ì°¸ê³  í™”ë©´
        
        ![Untitled](9864d338-162d-42d6-9605-6f5ca4795c84.png)
        
    
    ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ì„œ userIdë¥¼ pathvariableë¡œ ë°›ì•„ì„œ ì„¤ê³„
    
    ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ êµ¬í˜„
    
    ì‚¬ìš©ìì— ë” ì¤‘ì ì ì¸ apië¼ê³  íŒë‹¨í•˜ì—¬ usersë¡œ ë¶„ë¦¬
    
    â†’ dto ì¬ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ reviewë¡œ ë¶„ë¦¬í–ˆì–´ë„ ê´œì°®ì•˜ì„ ë“¯
    
    ```
    //ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·° ëª©ë¡
    app.get("/api/v1/users/me/:userId/reviews", handleListMyReviews);
    ```
    
    ```jsx
    //user.controller.js
    export const handleListMyReviews = async (req, res, next) => {
      const reviews = await listMyReviews(
      parseInt(req.params.userId),
      typeof req.query.cursor === "string" ? parseInt(req.query.cursor) : 0  );
      res.status(StatusCodes.OK).json(reviews);
    };
    ```
    
    ```jsx
    //user.service.js
    export const listMyReviews = async (userId, cursor) => {
      const reviews = await getAllMyReviews(userId, cursor);
      return responseFromReviews(reviews);
    };
    ```
    
    ```jsx
    //user.repository.js
    export const getAllMyReviews = async (userId, cursor) => {
      const reviews = await prisma.review.findMany({
        select: {
          id: true,
          body: true,
          storeId: true,
          userId: true
        },
        where: { userId: userId, id: { gt: cursor } },
        orderBy: { id: "asc" },
        take: 5,
      });
    
      return reviews;
    };
    ```
    
    DTOëŠ” ê¸°ì¡´ review.dto.jsì— ìˆë˜ ê±¸ë¡œ ì¬ì‚¬ìš©
    
    > cursor ì¸ì ì „ë‹¬ ê´€ë ¨
    > 
    
    ```
    //review.service.js line:20
    export const listStoreReviews = async (storeId, cursor) => {
      const reviews = await getAllStoreReviews(storeId, cursor);
      return responseFromReviews(reviews);
    };
    ```
    
    ![image.png](image%203.png)
    
- ë¯¸ì…˜ 3 (íŠ¹ì • ê°€ê²Œì˜ ë¯¸ì…˜ ëª©ë¡)
    
    ```jsx
    //íŠ¹ì • ê°€ê²Œì˜ ë¯¸ì…˜ ëª©ë¡
    app.get("/api/v1/stores/:storeId/missions", handleListStoreMissions);
    ```
    
    ```jsx
    //mission.controller.js
    export const handleListStoreMissions = async (req, res, next) => {
      const missions = await listStoreMissions(
        parseInt(req.params.storeId),
        typeof req.query.cursor === "string" ? parseInt(req.query.cursor) : 0
      );
      res.status(200).json({
        result: reviews
      });
    };
    ```
    
    ```jsx
    //mission.service.js
    export const listStoreMissions = async (storeId, cursor) => {
      const missions = await getAllStoreMissions(storeId, cursor);
      return responseFromMissions(missions);
    };
    ```
    
    ```jsx
    //mission.repository.js
    export const getAllStoreMissions = async (storeId, cursor) => {
      const missions = await prisma.mission.findMany({
        select: { id: true, storeId: true, deadline: true, missionSpec: true, storeId: true },
        where: { storeId: storeId, id: { gt: cursor } },
        orderBy: { id: "asc" },
        take: 5,
      });
    
      return missions;
    };
    ```
    
    ```jsx
    //mission.dto.js
    export const responseFromMissions = (missions) => {
      return {
        data: missions,
        pagination: {
          cursor: missions.length ? missions[missions.length - 1].id : null,
        },
      };
    };
    ```
    
    ![image.png](image%204.png)
    
- ë¯¸ì…˜ 4 (ë‚´ê°€ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ ëª©ë¡)
    
    ```jsx
    //ë‚´ê°€ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ ëª©ë¡
    app.get("/api/v1/missions/me/:userId/challenges", handleListMyChallenges)
    ```
    
    ```jsx
    //ë‚´ê°€ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ ëª©ë¡
    export const handleListMyChallenges = async (req, res, next) => {
      const challenges = await listMyChallenges(
        parseInt(req.params.userId),
        typeof req.query.cursor === "string" ? parseInt(req.query.cursor) : 0
      );
      res.status(200).json({
        result: challenges
      });
    };
    ```
    
    ```jsx
    //mission.service.js
    export const listMyChallenges = async (userId, cursor) => {
      const challenges = await getAllMyChallenges(userId, cursor);
      return responseFromMissions(challenges);
    };
    ```
    
    ```jsx
    //mission.repository.js
    export const getAllMyChallenges = async (userId, cursor) => {
      const challenges = await prisma.userMission.findMany({
        where: {
          userId: userId,
          status: "in_progress",
          id: { gt: cursor },
        },
        orderBy: { id: "asc" },
        take: 5,
        select: {
          id: true,          // UserMission id
          mission: {         // relation í†µí•´ Mission ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            select: {
              storeId: true,
              deadline: true,
              missionSpec: true,
            },
          },
        },
      });
      return challenges;
    };
    ```
    
    ![image.png](image%205.png)
    
- ë¯¸ì…˜ 5 (ë‚´ê°€ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì„ ì§„í–‰ ì™„ë£Œë¡œ ë°”ê¾¸ê¸°)
    - ì°¸ê³  í™”ë©´
        
        ![Untitled](Untitled.png)
        
    
    ```
    //ë¯¸ì…˜ì™„ë£Œì²˜ë¦¬
    app.patch("/api/v1/missions/:missionId/challenges/:userId", handleChallengeComplete);
    ```
    
    ```jsx
    export const handleChallengeComplete = async (req, res, next ) => {
        const mission_id = req.params.missionId;
        const user_id = req.params.userId;
    
        const entireCompletedChallengeData = {
            mission_id,
            user_id
        };
    
        const completedChallenge = await challengeComplete(bodyToChallenge(entireCompletedChallengeData));
        res.status(StatusCodes.OK).json({ result: completedChallenge });
    }
    ```
    
    ```jsx
    
    // ë‹¨ìˆœ ì¡°íšŒ
    export const findUserMission = async ({ userId, missionId }) => {
      return await prisma.userMission.findFirst({
        where: { userId: userId, missionId: missionId },
      });
    };
    
    // ì™„ë£Œ ì²˜ë¦¬ë§Œ
    export const updateMissionComplete = async (missionId) => {
      return await prisma.userMission.update({
        where: { id: missionId },
        data: { status: "completed" },
      });
    };
    ```
    
    ```jsx
    export const challengeComplete = async ({ userId, missionId }) => {
      // 1. ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      const userMission = await findUserMission({ userId, missionId });
    
      if (!userMission) {
        throw new Error("í•´ë‹¹ ë¯¸ì…˜ì— ëŒ€í•œ ë„ì „ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    
      // 2. ì´ë¯¸ ì™„ë£Œëœ ë¯¸ì…˜ì¸ì§€ í™•ì¸
      if (userMission.status === "completed") {
        throw new Error("ì´ë¯¸ ì™„ë£Œëœ ë¯¸ì…˜ì…ë‹ˆë‹¤.");
      }
    
      // 3. ì™„ë£Œ ì²˜ë¦¬
      const CompletedChallenge = await updateMissionComplete(userMission.id);
    	
    	//ì¬ì‚¬ìš©
      return responseFromChallenge(CompletedChallenge);
    };
    ```
    
    ìš°ì„  ë„ì „í•œ ì´ë ¥ì´ ìˆëŠ” ì§€ë¥¼ í™•ì¸, í›„ì— ì´ë¯¸ ì™„ë£Œë˜ì§€ ì•Šì•˜ëŠ” ì§€ ê²€ì¦í•˜ëŠ” ë¡œì§ì„ ê±°ì¹œë‹¤.
    
    ![image.png](image%206.png)
    
    ![image.png](image%207.png)